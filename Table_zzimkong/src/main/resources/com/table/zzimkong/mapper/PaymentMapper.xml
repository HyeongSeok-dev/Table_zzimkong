<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.table.zzimkong.mapper.PaymentMapper">
    <!-- [payment/payment] -->
	<select id="selectResForPay" resultType="res">
		 SELECT *
		 FROM reservation
		 WHERE res_num = #{res_num}
	</select>
	
	<select id="selectPoint" resultType="int">
		SELECT sum(point_value) 
		FROM point
		WHERE point_status != 2
		GROUP BY user_idx 
		HAVING user_idx = #{user_idx}
	</select>
	
	<select id="selectResCom" resultType="company">
		SELECT com_name, com_address
		FROM company
		WHERE com_id = #{com_id}
	</select>

	<select id="selectPreOrder" resultType="poi">
		SELECT pre.pre_num, pre.menu_idx, menu.menu_name, menu_price 
		FROM pre_order pre , menu
		WHERE res_idx = #{res_idx} AND pre.menu_idx = menu.menu_idx;
	</select>
	
	<!-- [paymentPro] -->
	<insert id="insertPayment">
		INSERT
		INTO payment
		VALUES (
			null
			, #{payNum}
			, #{res_idx}
			, #{sIdx}
			, #{pay_method}
			, #{res_table_price}
			, #{pay_po_price}
			, now()
			, #{pay_card_co}
			, #{per_Info_consent}
			, 1 -- pay_status
			<!--#{pay_po_site}  -->
			<choose>
				<when test="pay_po_price > 0">
					<choose>
						<when test="pay_po_site == 2">
						, 2
						</when>
						<when test="pay_po_site != 2">
						, 3
						</when>
					</choose>
				</when>
				<otherwise>
					,1
				</otherwise>
			</choose>
		)
	</insert>
	
	<insert id="insertSubUsedPoint">
		INSERT
		INTO point
		VALUES (
			null
			, #{user_idx}
			, #{discountPoint}
			, 4
			, null
			, 1
			, now()
		)
	</insert>

	<insert id="insertAddPoint">
		INSERT
		INTO point
		VALUES (
			null
			, #{user_idx}
			, #{earnedPoints}
			, 1
			, null
			, 1
			, now()
		)
	</insert>

	<!-- 예약테이블에 결제상태 update -->	
	<update id="updateReservationStatus">
		UPDATE reservation
		SET res_pay_status = 1
		WHERE res_num = #{res_num}
	</update>
	
</mapper>